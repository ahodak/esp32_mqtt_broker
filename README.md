# ESP32 MQTT Broker

MQTT брокер для ESP32 с веб-интерфейсом управления и поддержкой OTA обновлений.

## Описание

Проект представляет собой легковесный MQTT брокер, работающий на ESP32. Поддерживает работу как через WiFi (в режиме клиента или точки доступа), так и через Ethernet (для плат с поддержкой Ethernet).

### Основные возможности:

- MQTT брокер с поддержкой QoS 0
- Веб-интерфейс для управления и мониторинга
- Поддержка OTA обновлений
- Работа через WiFi или Ethernet
- Настройка параметров через веб-интерфейс
- Мониторинг системных параметров
- Публикация и подписка на топики через веб-интерфейс

## Поддерживаемые платы

### TTGO T-Display

- Встроенный TFT дисплей для отображения статуса
- Подключение через WiFi

### Wireless-tag WT32-ETH01

- Подключение через Ethernet
- Поддержка PoE (зависит от модификации платы)
- Более стабильное сетевое соединение

## Установка и настройка

### Параметры по умолчанию

- SSID: `MQTT-Broker-Setup`
- Пароль WiFi: `12345678`
- Имя хоста: `esp32-mqtt`
- MQTT пользователь: `admin`
- MQTT пароль: `admin`
- Задержка перезагрузки: 5 секунд

### Первоначальная настройка

1. При первом включении устройство создает точку доступа с указанными выше параметрами
2. Подключитесь к точке доступа
3. Откройте веб-интерфейс по адресу `192.168.4.1`
4. Перейдите в раздел "Настройки"
5. Укажите параметры вашей WiFi сети
6. Сохраните настройки, устройство перезагрузится
7. Подключитесь к вашей WiFi сети
8. Найдите устройство по имени хоста или IP адресу

## Веб-интерфейс

### Главная страница

- Отображение системной информации
- Статус подключения
- Параметры сети
- Время работы
- Использование памяти

### Публикация сообщений

- Ручная публикация MQTT сообщений
- Указание топика и содержимого сообщения

### Подписка на топики

- Подписка на MQTT топики
- Отписка от топиков

### Настройки

- Параметры WiFi (SSID, пароль)
- Имя хоста
- Учетные данные MQTT
- Задержка перезагрузки

### Обновление прошивки

- Проверка наличия обновлений
- Автоматическое OTA обновление
- Отображение текущей и доступной версии

## Используемые библиотеки

### Основные

- Arduino core for ESP32
- PicoMQTT (легковесный MQTT брокер)
- TFT_eSPI (для TTGO T-Display)
- WebServer
- WiFi
- ETH (для WT32-ETH01)

### Дополнительные

- ArduinoJson
- Preferences (для хранения настроек)
- Update (для OTA обновлений)
- OneWire (для датчика температуры)
- DallasTemperature (для датчика температуры)

## OTA обновления

Проверка наличие новых версий прошивки выполняется на странице `Прошивка`. При наличии обновления:

1. На странице появится информация о новой версии
2. Нажмите кнопку "Обновить" для начала процесса
3. Дождитесь завершения обновления
4. Устройство автоматически перезагрузится

## Сборка проекта

Проект использует PlatformIO для сборки. Для разных плат используются разные профили сборки:

- `ttgo-t-display` - для TTGO T-Display
- `wt32-eth01` - для WT32-ETH01
- `esp32dev` - для ESP32 Dev Module

## Использование датчиков

Для использования датчика температуры DS18B20 необходимо подключить его к плате на пин GPIO13.
Полученные с датчика данные публикуются в топик `opentherm/sensors/room_temp/set`.
Формат сообщения:
```json
{
    "connected": true,
    "value": 22.5
}
```

## Таблица разделов

### 4Мб

# Name,     Type,   SubType,    Offset,     Size,     Flags
nvs,        data,   nvs,        0x009000,   0x004000,
otadata,    data,   ota,        0x00D000,   0x002000,
app0,       app,    ota_0,      0x010000,   0x1F0000,
app1,       app,    ota_1,      0x200000,   0x1F0000,

### 8Мб

# Name,     Type,   SubType,    Offset,     Size,       Flags
nvs,        data,   nvs,        0x009000,   0x004000,
otadata,    data,   ota,        0x00D000,   0x002000,
app0,       app,    ota_0,      0x010000,   0x330000,
app1,       app,    ota_1,      0x340000,   0x330000,
spiffs,     data,   spiffs,     0x670000,   0x190000,

### 16Мб
# Name,     Type,   SubType,    Offset,     Size,     Flags
nvs,        data,   nvs,        0x009000,   0x375000,
otadata,    data,   ota,        0x37E000,   0x002000,
app0,       app,    ota_0,      0x380000,   0x320000,
app1,       app,    ota_1,      0x6A0000,   0x320000,
spiffs,     data,   spiffs,     0x9C0000,   0x640000,

## Лицензия

MIT License

## Автор

Андрей Ходак (andrey@khodak.ru)